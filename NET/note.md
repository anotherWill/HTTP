《图解HTTP》
========================

## 内容介绍：

	- HTTP方法。
	- 协议格式。
	- 报文结构。
	- 首部字段。
	- 状态码。
	- 代理。
	- 网关。
	- 隧道。
	- HTTP拓展功能。
	- 无状态。
	- 301和302重定向的区别。
	- 缓存机制。
	- Web安全。
	- 等
	- 等。

## NOTE (HyperText Transfer Protocol 超文本传输协议)
	- 客户端通过指定的访问地址获取/上传服务器资源；服务端使用HTTP协议的的通信。Web是建立在HTTP协议通信上的。
	- CERN(欧洲核子研究组织)的一个博士提出一种让远隔两地的研究者们共享知识的设想。最初的设计理念：借助多文档之间的相互关联(个人理解成a标签之类的还有URL的东西)形成的超文本，连成可相互参阅的WWW(World Wide Web)万维网。
	- WWW构建技术(Web)：把SGML(标准通用标记语言)作为页面的文本标记语言HTML(超文本标记语言);作为文档传递协议的HTTP；指定文档所在地址的URL(统一资源定位符)。
	- 当年HTTP协议的出现主要是为了解决文本传输的难题。现在HTTP协议已经超出了Web这个框架的局限。
	- 通常使用的网络时在TCP/IP协议族的基础上运作的。HTTP属于它内部的一个子集。
	- 协议是指不同的硬件、操作系统之间的通信(如何探测通新目标、哪一边发起通信、使用什么语言进行通信、怎样结束通信)，这一切都需要一些规则。这些规则就是协议。这些协议的集合总称就是TCP/IP。
	- TCP/IP协议族按层次分别：应用层、传输层、网络层、数据链路层。
	- 应用层决定了向用户提供应用服务通信时通信的活动。TCP/IP协议族预存了各类通用的应用服务。如FTP(文本传输协议)和DNS(域名系统)。HTTP协议也处于该层。
	- 传输层对上层应用层，提供处于网络连接中的两台计算机之间的数据传输。TCP(传输控制协议)/UDP(用户数据报协议)
	- 网络层(网络互联层)。用来处理网络上流动的数据包(网络传输的最小数据单位)。该层规定了传输路径并把数据包传送给对方(与对方计算机之间通过多台计算机或网络设备进行传输时，网络层所起的作用就是在众多的选项内选择一条传输路线)。
	- 链路层(网络接口层)。处理网络的硬件部分。包括控制系统、硬件的设备驱动、NIC(网络适配器即网卡)、光纤等物理可见部分。
	- 客户端与服务端进行通信时，会通过分层顺序与对方进行通信，发送端从应用层往下走，接收端则从链路层往上走。例如(HTTP)：首先作为发送端的客户端在应用层发出一个想看某个Web页面的HTTP请求；为了传输方便，在传输层(TCP协议)把从应用层处收到的数据(HTTP请求报文)进行分割，并在各个报文上打上标记序号及端口号转发给网络层。在网络层(IP协议)增加作为通信目的地的MAC地址转发给链路层。到此为止，发往网络的通信请求就准备齐全了。最后，接收端的服务器在链路层接收到数据，按序往上层发送，一直到应用层。但传输到应用层，才能算真正接收到由客户端发送过来的HTTP请求。发送端在层与层之间传输数据时，每经过一层时必定会被打伤一个该层所属的头部信息。反之，接收端在层与层传输数据时，每经过一层时会把对应的首部去掉。图demo1.png
	- 负责传输IP(网际协议)位于网络层。作用是把各种数据包送给对方。确保传送的两个重要条件：IP地址(指明了节点被分配的地址，不可变换)和MAC地址(网卡所属的固定地址，可变换)。IP地址可以和MAC地址进行配对。
	- ARP协议。IP间的通信依赖MAC地址。网络上通信一般经过多台计算机和网络设备中转才能连接到对方。而在中转时，会利用下一台中转设备的MAC地址来搜索下一个中转目标。这时机会采用ARP协议。它是泳衣以解析地址的协议，根据通信方的IP地址就可以反查出对应的MAC地址。
	- 获悉传输路线的机制称为路由选择。无论那台计算机、哪台网络设备，他们都无法全面掌握互联网中的细节。
	- TCP协议确保可靠性。位于传输层，提供字节流服务(为了方便传输，将大块数据分隔成以报文段为单位的数据包进行管理)。可以确认数据最终是否送达到对方(因为三次握手)。TCP协议把数据包送出去后，会向对方确认是否成功送达。握手标志——SYN(synchronize)和ACK(acknowledgement)。发送端首先发送一个带SYN标志的数据包给对方，接收端收到后回传一个带有SYN/ACK标志的数据包表示传达确认信息。最后，发送端再回传一个带ACK标志的数据包，代表握手结束。如果握手过程终端，TCP协议会再次以相同的顺序发送相同的数据包。
	- DNS服务位于应用层。提供域名到IP地址之间的解析服务。demo2.png demo3.png
	- URI(统一资源标识符)。URI用字符串标识某一互联网资源，而URL表示资源的地点。URL是URI的子集。
	- HTTP协议用于客户端和服务端之间的通信。通过请求和响应的交换达成通信。肯定是先从客户端开始建立通信的。
	- 请求报文是由请求方法、请求URI、协议版本、可选的请求首部字段和内容实体等构成。demo4.png、demo5.png
	- HTTP是一种不保存状态，即无状态协议。协议对于发送过的请求或响应都不做持久化处理。每次有新的请求过来就有会对应的新的响应产生。更新请求和报文信息。
	- HTTP协议使用URI让客户端定位到资源。当客户端请求访问资源而发送请求是，URI需要将作为请求报文中的请求URI包含在内。
	- GET(获取资源)方法用来请求访问已被URI识别的资源。指定的资源经服务器端解析后返回响应内容。如果是文本则保存原样返回、程序则返回执行后的结果[获取页面时返回304状态码表示自从上次请求页面没有更新]；POST，传输实体主体，GET也可以实现(GET和POST功能相似)，传输一般用POST。它的目的并不是获取响应的主体内容。PUT上传文件。DELETE删除文件[PUT和DELETE返回204表示操作成功但是没有返回内容]。HEAD获取报文头部。OPTIONS查询针对请求URI指定的资源支持方法[会返回Allow:GET,POST...]。TRACE路径追踪。请求想要连接到源目标服务器可能通过代理中转，TRACE方法用来确认连接过程中发生的一系列操作。CONNECT用隧道协议连接代理。要求与代理服务器通信时建立隧道，实现用隧道协议进行TCP通信。
	- 持久连接(keep-alive)，只要任意一端没有明确提出断开连接，则保持TCP连接状态。它减少了 TCP连接的重复建立和断开所造成的额外开销，减轻了服务端的负载。不用等待响应才能发送下一个请求，可以同时并行发送多个请求。demo6.png
	- HTTP是无状态协议。Cookie技术通过在请求和响应报文中写入Cookie信息来控制客户端的状态。Cookie会根据从服务器发送的响应报文内的一个叫做Set-Cookie的首部字段信息，通知客户端保存Cookie。当下次客户端再往服务器发送请求时，客户端会自动在请求报文中加入Cookie值后发送出去。服务器发现客户端发送过来的Cookie后，会去检查是从哪个客户端发来的请求人，然后对比服务器上的记录。demo7.png
	- HTTP协议交互的信息叫做报文。分为请求报文和响应报文。报文分为报文首部和报文主体。
	- 实体主体和报文主体一致(当进行编码操作时，才和报文编码产生差异。)。编码提升传输效率。压缩传输的内容编码。内容编码指明应用在实体内容上的编码格式，并保持实体信息原样压缩，内容编码后的实体有客户端接收并负责解码。demo9.png。分隔发送的分块传输编码。让页面逐步显示比页面无法显示要好。传输编码可以在通信时按某种编码方式传输，只定义作用于分块传输编码中。demo10.png。
	- 发送多种数据的多部分对象集合。MIME(多用途因特网邮件扩展)拓展中会使用一种称为多部分对象集合的方法来容纳多分不同类型的数据。multipart/form-data(web表单文件上传时使用)、multipart/byteranges状态码206(部分内容)响应报文包含了多个范围的内容同时使用。demo11.png.
	- 获取部分内容的请求范围。即能从之前下载中断处恢复下载。如果服务器无法响应范围请求，则会返回状态码200OK和完整的实体内容。
	- 内容协商机制是指客户端和服务端就响应的资源内容进行交涉，然后提供给客户端最为合适的资源。[Accept/Accept-Charset/Accept-Encoding/Accept-Language/Content-Language]
	- 状态码。demo12.png. 204 No Content，请求处理成功，但是没有资返回(没有实体主体/报文主体)。2XX成功。206 Partial Content范围请求，服务器成功执行了这部分的GET请求。响应报文中包含由Content-Range指定范围的实体内容。
	- 3XX重定向。301 Moved Permanently永久性重定向。请求的资源被分配了新的URI。302 Found临时性重定向。[301.302禁止将POST方法改成GET，但是浏览器都会这样做]303 See Other该状态码表示由于请求对应的资源存在着另一个URI。要采用GET方法定向获取请求的资源。304 Not Modified 该状态码表示客户端发送附带条件的请求是，服务端允许访问资源，单为满足条件的情况。307 Temporary Recirect临时重定向。307不会从POST变成GET。
	- 4XX客户端错误。400 Bad Request表示请求报文中存在语法错误。401 Unauthorized该状态码表示发送的请求需要有通过HTTP认证的认证信息或认证没通过。403 Forbidden表明对请求资源的访问被服务器拒绝了，权限出现问题。404 Not Found服务器没有找到请求的资源
	- 5XX服务器错误。500 Internal Server Error服务器错误。503 Service Unavailable表示服务器暂时处于超负载或者正在进行停机维护，无法处理请求。
	- 虚拟主机，一台服务器搭建多个web站点。可以寄存多个不同主机名和域名的Web网站。
	- 代理服务器是接受客户端发送的请求后转发给其他服务器。代理不改变请求URI，会直接发送给前方持有该资源的目标服务器。缓存代理会预先把资源的副本保存到代理服务器上，这样请求相同资源时就可以不从源服务器获取资源。
	- 网关可以由HTTP请求转化为其他协议通信。
	- 隧道的目的是确保客户端能与服务端进行安全的通信。
	- 通用首部字段[demo13.png];请求首部字段[demo14.png];响应首部字段[demo15.png];实体首部字段[demo16.png]

## 通用首部字段：
	- 以下Cache-Control指令内容
	- no-cache指令的目的是为了防止从缓存中返回过期的资源；客户端发送的请求中如果包含no-cache指令，则表示客户端不会接受缓存过的响应。缓存服务器必须把客户端请求转发给源服务器。服务器返回的响应中包含no-cache指令，缓存服务器不能对资源进行缓存。源服务器也不再对缓存服务器请求中提出的资源有效性进行确认，且禁止其对响应资源就行缓存操作。
	- no-cache代表不缓存过期的资源，缓存会向源服务器进行有效期确认后处理资源。no-store才是不进行缓存。
	- max-age为0时，缓存服务器通常需要将请求转发给源服务器。
	- only-if-cached要求缓存服务器不重新加载响应，也不会再次确认资源有效性。若发生请求缓存服务器的本地缓存无响应，返回504 Gateway Timeout.
	- must-relvalidate指令，代理向源服务器再次验证即将返回的响应缓存目前是否仍然有效。如果代理服务器无法连通源服务器再次获取有效资源，缓存返回504
	- no-transform指令规定无论是在请求还是响应中，缓存都不能改变实体主体的媒体类型，可以防止缓存或代理压缩图片等类似操作。
	- 以下Connection
	- Connection首部字段可以控制不在转发给代理的首部字段和管理持久连接。
	- 默认连接是持久连接(Keep-Alive),当服务器想明确断开连接时，则值为close
	- Date规定了日期。
	- Trailer会说明在报文主体后记录了哪些首部字段。
	- Upgrade用于检测HTTP协议及其他协议是否可以使用更高版本进行通信，参数值可以用来指定一个完全不同的通信协议。
	- Via首部为了追踪传输路径会和TRACE方法一起使用。例如当代理服务器接收到由TRACE方法发送过来的请求(Max-Forwards:0)时，代理服务器就不能再转发该请求了。这种情况下，代理服务器会将自身的信息附加到Via首部后，返回改请求的响应。
	- Warning告知一些与缓存相关的问题的警告。警告码：demo17.png

## 请求首部字段	
  - 请求首部字段是从客户端网服务端发送请求报文中使用的字段，补充请求的附加信息、客户端信息、对响应内容相关的优先级等内容。
  - Accept首部字段可通知服务器，用户代理能够处理的媒体类型及媒体类型的相对优先级。q表示权重。
	- Accept-Charset首部字段用来通知服务器用户代理支持的字符集及字符集的相对顺序。q表示权重。
	- Accept-Encoding首部字段用来告知服务器用户代理支持的内容编码及内容编码的优先级顺序[压缩：gzip/compress/deflate/identity]。q表示权重。
	- Accept-Language首部字段告知服务器用来代理能够处理的自然语言集。q表示权重。
	- Authorization用来告知服务器用户代理的认证信息。
	- Expect首部字段告知服务器期望出现某种特定行为。如服务器无法理解客户端的期望做出回应而发生错误是，会返回417 Expectation Failed。
	- From告知服务器使用用户代理的用户的电子邮件地址。
	- Host 虚拟主机运行在同一个IP上，使用首部字段Host(www.hackr.jp)区分。他会告知服务器，请求的资源所处 的互联网主机名和端口号。首部字段Host和以单台服务器分配多个域名的虚拟主机的工作机制有很密切的关系。
	- 请求被发送至服务器时，请求中的主机名会用IP地址直接替换解决。如果相同的IP地址下部署运行多个域名，那么服务器无法理解究竟是那个域名对应的请求。Host用来明确指出请求的主机名。
	- If-Match条件请求。服务器接收到附带条件的请求时，只有条件为真时，才会执行请求，否则返回412 Precondition Failed。If-Match内容为*时只要资源存在就处理请求。
	- If-Modified-Since字段指定的日期时间后，资源发生了更新，服务器会接受请求。如果在指定日期时间之后请求都没有更新过，则返回304 Not Modified响应。
	- If-None-Match与If-Match相反。不匹配时处理请求。
	- If-Range字段值和Range配合使用若是和ETag(实体标记)值或更新的日期时间匹配一致，那么久作为范围请求处理，否则返回全部资源。
	- If-Unmodified-Since和If-modified-Since相反，指定的资源只有在字段值内的日期时间之后，未发生更新才能处理请求，否则返回412 Precondition Failed。
	- Max-Forwards转发次数。数值为0时不再转发，直接返回响应。可用于判断终点服务器的传输路径的通信状况。
	- Proxy-Authorization客户端和代理之间的认证。代理服务器发送认证咨询，客户端发送告知服务器认证所需要的信息。Authorization是客户端和服务器之间的认证。
	- Range获取部分资源。处理请求返回206 Partial Content。佛则返回200 OK全部资源。
	- Referer告知服务器请求的原始资源URI。原始资源可能带有ID或者密码，转发过程可能泄密。所以一般不发送该首部字段。
	- TE告知服务器客户端能够处理响应的传输编码方式及权重。
	- User-Agent会将创建请求的浏览器和用户代理名称等信息传达给服务器。

##响应首部字段
	- 由服务端向客户端返回响应报文中使用的字段，用于补充响应的附加信息、服务器信息以及对客户端的附加要求等信息。
	- Accept-Ranges告知客户端是否能进行范围处理，以指定获取服务器端的某个部分的资源。
	- Age告知客户端，源服务器在多久前创建了响应。字段值为秒。
	- ETag告知客户端实体标识，是服务器将资源做的唯一标识。当资源更新ETag也需要更新。
	- Location可以将响应接受方引导至某个请求的URI位置不同的资源。
	- Proxy-Authenticate会把由代理服务器所要求的认证信息发送给客户端。WWW-Authroizaton是服务器和客户端进行认证。
	- Retry-After告知服务器多久之后再次发送请求。配合503 Service Unavailable响应。
	- Server告知客户端当前服务器端上安装的HTTP服务器应用程序的信息。
	- Vary对缓存进行控制。源服务器会向代理服务器传达关于本地缓存使用方法的命令。demo18.png
	- WWW-:Authenticate用于HTTP访问认证。告知客户端用于访问请求的URI所指定的资源的认证方案和带参数提示的质询。

##实体首部字段
	- 实体首部字段是包含在请求报文和响应报文中的实体部分所使用的首部，用于补充内容的更新时间等与实体相关的信息。
	- Allow通知客户端能够支持Request-URI指定资源的所有http方法。不支持HTTP方法时，返回405 Method Not Allowed作为响应返回。
	- Content-Encoding稿子客户端服务器对实体的主体部分选用的内容编码方式(Accept-Encoding提到的4中内容编码方式)。
	- Content-Language告知客户端实体主体使用的自然语言。
	- Content-Length表明了实体主体部分的大小(字节)。对实体主体进行内容编码是，不再使用Content-Length字段。
	- Content-Location给出与报文主体对应的URI。表示报文主体返回资源对应的URI。
	- Content-MD5客户端会对接收的报文主体执行相同的MD5算法，然后与首部字段Cotnent-MD5的字段值比较。
	- Content-Range告知客户端作为响应返回的实体的那个符合范围请求.
	- Content-Type说明了实体主体内对象的媒体类型。字段值用type/subtype形式赋值。
	- Expires会将资源失效的日期告知客户端。在日期之前，副本会一直被保存，否则缓存服务器接受客户端请求时会转向源服务器请求资源。当首部字段Cache-Control有指定max-age指令时，比起首部字段Expires会优先处理max-age指令。
	- Last-Modified指明资源最终修改的时间/数据最终修改时的时间。

##为Cookie服务的首部字段
	- Cookie的工作机制是当用户识别及状态管理。调用Cookie时要校验Cookie的有效期，以及发送方的域、路径、协议等信息。
	- Set-Cookie服务端发给客户端，是响应首部字段。Cookie客户端发给服务端，是请求首部字段。
	- Set-Cookie字段属性。demo19.png
	- Cookie告知服务器，当客户端想获得HTTP状态管理支持时，就会在请求中包含从服务器接收到的Cookie。

##HTTPS超文本传输安全协议
	- HTTP使用明文，内容可能被窃听，不验证通信方身份，可能遭遇伪装，无法证明报文完整性，所以有可能报文早篡改。
	- 通信加密。HTTP和SSL安全套接层或TLS安全层传输协议组合使用。加密HTTP通信内容。SSL组合使用的HTTP称为HTTPS
	- 内容加密。把HTTP报文里所含的内容进行加密处理。因为不是整个通信线路加密，所以内容有可能被篡改。
	- HTTP协议不确认通信方，服务器只要收到请求都会返回响应。服务器有可能是伪装服务器；伪装客户端；客户端是否有权限，接受无意义请求(DOS攻击)。
	- SSL确定通信方(通过证书)。客户端只有证书完成个人身份确认。服务端持有证书让客户端确认服务器。
	- 文件内容在传输过程中可能被篡改。请求或响应在传输途中遭攻击者拦截病篡改内容的攻击称为中间人攻击。
	- 加密及认证机制的HTTP称为HTTPS.
	- HTTP通信接口部分用SSL和TLS协议代替。通常HTTP和TCP通信，当使用SSL时，HTTP先和SSL通信，再由SSL和TCP通信。SSL独立于HTTP，可以在其他应用层的SMTP和Telnet等下一配合SSL协议使用。
	- 共享秘钥不安全。对称。
	- 公有秘钥和私有秘钥非对称。发送密文的一方使用对方的公开秘钥进行加密处理，对方收到加密的信息后，使用自己的私有秘钥进行解密。
	- HTTPS采用混合加密机制。公开秘钥较慢。在交换秘钥环节使用公开秘钥加密，通信交换报文阶段用共享秘钥加密。公开秘钥的密钥替换了共享密钥的密钥[demo20.png]。
	- 公开秘钥可能会被替换。所以需要数字证书。demo21.png
	- SSL慢的原因：通信慢；加密解密引起的运算小号CPU和内存资源导致处理速度变慢。
	- 认证方式：BASIC基本认证。DIGEST摘要认证。SSL客户端认证。FormBase认证(基于表单认证)
	- SSL认证步骤，服务器接收到需要认证的资源，要求客户端提供客户端证书。客户端发送证书信息后服务器验证客户端证书，通过后才能领取证书内容客户端的公开密钥。
	- SSL客户端双因素认证。第一种认证客户端计算机、第二种认证密码确定本人行为。
	- HTTP是无状态协议、之前已认证成功的用户状态无法通过协议层面保存下来。即，无法实现状态管理，因此即使当该用户下一次
继续访问，也无法区分他与其他的用户。于是我们会使用Cookie来管理Session，以弥补HTTP协议中不存在的状态管理功能.
	- 客户端接收到从服务器端发来的Session后，会将其作为Cookie保存在本地。下次向服务器发送请求时、浏览器会自动发送Cookie,所以Session lD也随之发送到服务器。服务器端可通过验证接收到的Session ID识别用户和其认证状态。
	- WebSocket，即Web浏览器与Web服务器之问全双工通信标准。由于是建立在HTTP基础上的协议，因此连接的发起方仍是客户端。而一旦确立Websocket通信连接.不论服务器还是客户端，任意一方都可直i接向对方发送报文。
	- WebSocket特点。推送：服务器可直接发送数据，而不必等待客户端的请求。减少通信量：首部信息小。
	- 握手请求。需要用到HTTP的Upgrade首部字段，告知服务器通信协议发生改变，以达到握手的目的。
	- 握手响应。对于之前的请求，返回101 Switching Protocols响应。demo22.png
	- 跨站脚本攻击XSS、SQL注入攻击、OS命令注入攻击、HTTP首部注入攻击、邮件首部注入攻击、目录遍历攻击、远程文件包含漏洞
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
	-
